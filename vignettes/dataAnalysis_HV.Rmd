---
title: "Data analysis : test of hybrid immune vigor in response to parasite infection"
author: "Alice Balard"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation

```{r install}
library(parasiteLoad)
library(bbmle)
require(optimx) # for bbmle it needs to be required(?)
library(ggplot2)
library(MASS)
```

## Prepare dataset for each analysis

```{r prepData}
qpcr_data <- BALdata[!is.na(BALdata$HI) &
                       !is.na(BALdata$Sex) &
                       !is.na(BALdata$delta_ct_MminusEAllPos), ]

flotation_data <- BALdata[!is.na(BALdata$OPG) &
                            !is.na(BALdata$HI) &
                            !is.na(BALdata$Sex), ]

pinworms_data <- BALdata[!is.na(BALdata$Aspiculuris_Syphacia) &
                           !is.na(BALdata$HI) &
                           !is.na(BALdata$Sex),]

body_data <- BALdata[!is.na(BALdata$Body_weight) &
                       !is.na(BALdata$Body_length) &
                       !is.na(BALdata$HI) &
                       !is.na(BALdata$Sex) &
                       !is.na(BALdata$qPCRstatus) ,]
WATWMdata <- WATWMdata[!is.na(WATWMdata$Aspiculuris.Syphacia) &
                         !is.na(WATWMdata$HI) &
                         !is.na(WATWMdata$Sex), ] 
```

## Part 1. qpcr results, 4 hypotheses, difference between sexes

### Choose a correct distribution for our data

Let's compute some fits...

```{r, choosefitsqpcr}

qpcr_data[qpcr_data$delta_ct_MminusEAllPos > 0,"delta_ct_MminusEAllPos"]

fits_test_qpcr <- list(
  normal = MASS::fitdistr(qpcr_data[qpcr_data$delta_ct_MminusEAllPos > 0,"delta_ct_MminusEAllPos"],
                          "normal"),
  student = MASS::fitdistr(qpcr_data[qpcr_data$delta_ct_MminusEAllPos > 0, "delta_ct_MminusEAllPos"], "t",
                     start = list(m = mean(qpcr_data[qpcr_data$delta_ct_MminusEAllPos > 0, "delta_ct_MminusEAllPos"]),
                                  s = sd(qpcr_data[qpcr_data$delta_ct_MminusEAllPos > 0, "delta_ct_MminusEAllPos"]),
                                  df=3), lower=c(-1, 0.001,1))
)

#Get the logliks for each model...

sapply(fits_test_qpcr, function(i) i$loglik)
```

STUDENT is the way to go!

### Run the fit with Student distribution

```{r runfitqpcr}
fit_qpcr_student <- analyse(qpcr_data[qpcr_data$delta_ct_MminusEAllPos > 0, ],
                               response = "delta_ct_MminusEAllPos", 
                            model = "student", group = "Sex")
fit_qpcr_student
```

Plot the more likely hypothesis, H0

```{r plotfitqpcr}
plot_qpcr_student <- bananaPlots(mod = fit_qpcr_student$H0, 
                                 data = qpcr_data[qpcr_data$delta_ct_MminusEAllPos > 0, ], 
                                 response = "delta_ct_MminusEAllPos", group = "Sex")
plot_qpcr_student
```

## Part 2. OPG results, 4 hypotheses, difference between sexes

## Run the fit for load estimation along HI, negative binomial distribution

```{r runfitflot}
fit_flotation_negbin <- analyse(flotation_data[flotation_data$OPG > 0, ], 
                                   response = "OPG", 
                                   model = "negbin", group = "Sex")
fit_flotation_negbin
```

```{r plotfitflot}
# bananaPlots(mod = fit_flotation_negbin$H0, data = flotation_data, response = "OPG", group = "Sex")
# problems for the profiling...
```

## Part 3. worms count, 4 hypotheses, difference between sexes

### Choose a correct distribution for our data : negative binomial see WATWM

### pinworms (A. tetraptera and S. obvelata (WATWMdata$Aspiculuris.Syphacia))

```{r runfitJo}
fit_Joelle_negbin <- analyse(WATWMdata, "Aspiculuris.Syphacia", 
                             model = "negbin", group = "Sex")
fit_Joelle_negbin
```

```{r plotfitJo}                 
plot_Joelle_negbin <- bananaPlots(mod = fit_Joelle_negbin$H1, 
                                 data = WATWMdata, 
                                 response = "Aspiculuris.Syphacia", 
                                 islog10 = TRUE, group = "Sex") 
plot_Joelle_negbin
```

### And Jennys now:

```{r runfitJe}
fit_pinworms_negbin <- analyse(pinworms_data, "Aspiculuris_Syphacia", 
                               model = "negbin", group = "Sex")
fit_pinworms_negbin
```

```{r plotfitJe}
plot_pinworms_negbin <- bananaPlots(mod = fit_pinworms_negbin$H1, 
                                  data = pinworms_data, 
                                  response = "Aspiculuris_Syphacia", 
                                  islog10 = TRUE, group = "Sex") 
plot_pinworms_negbin
```

## qPCR vs worms (is there a correlation?)

```{r plotcorr}
ggplot2::ggplot(pinworms_data, 
       aes(delta_ct_MminusE, Aspiculuris_Syphacia + 1)) +
  geom_point(aes(fill = HI), pch = 21, size = 5) + 
  scale_fill_gradient(low = "blue", high = "red") +
  scale_y_log10() +
  geom_smooth(method = "lm") +
  theme_classic()

summary(lm(Aspiculuris_Syphacia ~ delta_ct_MminusE, data = BALdata))
```

## Part 4. body data, 4 hypotheses, difference between infected/not infected
### TO DO : test coinfection data!! Are coinfected individuals more suffering?

Remove pregnant/post partum and juveniles

```{r removepregnant}
body_data$status[body_data$Sex %in% c("F")] <- "non pregnant/lactating female"
body_data$status[body_data$Status %in% c("post partum", "post partum (lactating)", "pregnant")] <- "pregnant/lactating female"
body_data$status[body_data$Sex %in% c("M")] <- "male"

# Test  our detection of pregnancy in females using BCI
ggplot2::ggplot(body_data, 
       ggplot2::aes(x = HI, y = BCI, fill = status, group = status)) +
  geom_point(pch = 21, size = 3, alpha = .5)+
  geom_smooth(aes(col = status)) +
  theme_bw()

# Remove pregnant females
body_data <- body_data[!body_data$status %in% c("pregnant/lactating female"), ]
```

Regression of BM/BS for males and females (all together, then separate subsp.) 
Advantage: independant of size!!

* Step 1: fit the model

```{r fitresmod}
fitRes <- lm(Body_weight ~ Body_length * Sex, data = body_data)
```

* Step 2: obtain predicted and residual values

```{r getpredval}
body_data$predicted <- predict(fitRes)   # Save the predicted values
body_data$residuals <- residuals(fitRes) # Save the residual values
```

* Step 3: plot the actual and predicted values

```{r plotpredval}
ggplot2::ggplot(body_data, ggplot2::aes(x = Body_length, y = Body_weight)) +
  ggplot2::geom_smooth(method = "lm", se = FALSE, color = "lightgrey") +  # Plot regression slope
  ggplot2::geom_segment(ggplot2::aes(xend = Body_length, yend = predicted), alpha = .2) +  # alpha to fade lines
  ggplot2::geom_point(ggplot2::aes(col = delta_ct_MminusE), size = 3) +
  ggplot2::scale_color_gradient(low = "lightgrey", high = "red") +
  ggplot2::geom_point(ggplot2::aes(y = predicted), shape = 1) +
  ggplot2::facet_grid(~ Sex, scales = "free_x") +  # Split panels here by `iv`
  ggplot2::theme_bw()  # Add theme for cleaner look
```

* Step 4: use residuals as indice

```{r removeoutliers}
hist(body_data$residuals[body_data$Sex =="F"], breaks = 100) # remove outliers, keep [-5,5] interval

body_data <- body_data[body_data$residuals <= 5,]
body_data$resBMBL <- body_data$residuals

# give positive values only
body_data$resBMBL <- body_data$resBMBL + 5

# Plot the actual and predicted values
ggplot2::ggplot(body_data, ggplot2::aes(x = Body_length, y = Body_weight)) +
  ggplot2::geom_smooth(method = "lm", se = FALSE, color = "lightgrey") +  # Plot regression slope
  ggplot2::geom_segment(ggplot2::aes(xend = Body_length, yend = predicted), alpha = .2) +  # alpha to fade lines
  ggplot2::geom_point(ggplot2::aes(col = delta_ct_MminusE), size = 3) +
  ggplot2::scale_color_gradient(low = "lightgrey", high = "red") +
  ggplot2::geom_point(ggplot2::aes(y = predicted), shape = 1) +
  ggplot2::facet_grid(~ Sex, scales = "free_x") +  # Split panels here by `iv`
  ggplot2::theme_bw()  # Add theme for cleaner look
```

### Which distribution to choose?
 
Let's compute some fits...

```{r choosefitbody}
fits <- list(
  normal = MASS::fitdistr(body_data$resBMBL,"normal"),
  student = MASS::fitdistr(body_data$resBMBL, "t", 
                     start = list(m = mean(body_data$resBMBL), 
                                  s = sd(body_data$resBMBL), df = 3), 
                     lower=c(-1, 0.001,1))
)
# get the logliks for each model...
sapply(fits, function(i) i$loglik)
```

STUDENT is the way to go!

```{r plotdistribbody}
ggplot2::ggplot(body_data, ggplot2::aes(resBMBL)) +
  ggplot2::geom_histogram(ggplot2::aes(y=..density..), bins = 100) + 
  ggplot2::stat_function(fun = dnorm, n = 1e3, args = list(mean = fits$normal$estimate[1], sd = fits$normal$estimate[2]),
                ggplot2::aes(color = "normal"), size = 2) +
  ggplot2::stat_function(fun = dt, n = 1e3, args = list(ncp = fits$student$estimate[1], 
                                               df = fits$student$estimate[3]),
                ggplot2::aes(color = "student"), size = 2) +
  ggplot2::stat_function(fun = dt, n = 1e3, args = list(ncp = fits$student$estimate[1], 
                                               df = 10),
                ggplot2::aes(color = "student10"), size = 2) +
  ggplot2::stat_function(fun = dt, n = 1e3, args = list(ncp = fits$student$estimate[1], 
                                               df = 400),
                ggplot2::aes(color = "student500"), size = 2) +
  ggplot2::stat_function(fun = dt, n = 1e3, args = list(ncp = fits$student$estimate[1], 
                                               df = 1000),
                ggplot2::aes(color = "student1000"), size = 2) +
  ggplot2::stat_function(fun = dt, n = 1e3, args = list(ncp = fits$student$estimate[1], 
                                               df = 5),
                ggplot2::aes(color = "student5"), size = 2) +
  ggplot2::theme_bw(base_size = 24) 
```

### Fit the model!

```{r runfitbody}
fit_body_student <- analyse(body_data, response = "resBMBL",
                            model = "student", group = "qPCRstatus")

fit_body_student
```

And plot

```{r plotfitbody}
bananaPlots(mod = fit_body_student$H1, data = body_data, response = "resBMBL")

bananaPlots(mod = fit_body_student$H3, data = body_data, response = "resBMBL", group = "qPCRstatus")
```


# Suggestion from Stuart

Sounds very cool. You may well have thought of this, but anyway (because likelihood is lovely)... a nice zonewise pinworm comparison is as follows:

Do whole analysis on combined {WATWM, Jenny's} data -> Joint LLsurface
You already have the whole analyses on the zonewise-split of this joint data. -> {WATM LL surface,Jenny LL surface}
... and off we go: compare
Max(WATWM LL surface)+Max(Jenny LL surface) VS Max(Joint LLsurface)

On either side of the VS the same data is analysed - so LL comparison is valid. Any 'is there really a difference between the two zones re pinworms' style of question reduces to:
Force them to be the same (the joint analysis) VS allow them to be different (WATWM and Jenny's each have their own parameters).... once you have counted degrees of freedom you can look up the answer to any such  question in a ChiSquared table... its so sweeeet!
 (ok... there are lots of axes of heterogeneity... it not quite so simple as all that - but its basically what you do already re eg comparison of sexes)

```{r compare all worms}
fit_Joelle_negbin <- analyse(WATWMdata, "Aspiculuris.Syphacia", 
                             model = "negbin", group = "Sex")
fit_Joelle_negbin

fit_pinworms_negbin <- analyse(pinworms_data, "Aspiculuris_Syphacia", 
                               model = "negbin", group = "Sex")
fit_pinworms_negbin

d1 <- WATWMdata[c("Sex", "Aspiculuris.Syphacia", "HI")]
d2 <- pinworms_data[c("Sex", "Aspiculuris_Syphacia", "HI")]
names(d1) <- names(d2)
allWorms <- rbind(d1,d2)

fit_allWorms_negbin <- analyse(allWorms, "Aspiculuris_Syphacia", 
                               model = "negbin", group = "Sex")
fit_allWorms_negbin
```


