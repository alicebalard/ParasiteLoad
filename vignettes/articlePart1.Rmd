---
title: "Data analysis : test of hybrid immune vigor in response to parasite infection"
subtitle: "Article part 1"
author: "Alice Balard"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
  ```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation

```{r install}
library(parasiteLoad)
library(bbmle)
require(optimx) # for bbmle it needs to be required(?)
library(ggplot2)
library(MASS)
library(fitdistrplus) # evaluate distribution
library(epiR) # Sterne's exact method
library(simpleboot) # BS
library(boot) # BS
```

## Prepare dataset for each analysis

```{r prepData}
WATWMdata <- read.csv("../data/WATWMdata.csv")
BALdata <- read.csv("../data/BALdata.csv")

# add 1 for worms/oocysts count!!
WATWMdata$`Aspiculuris.Syphacia+1` <- WATWMdata$Aspiculuris.Syphacia + 1

BALdata$`Aspiculuris.Syphacia+1` <- BALdata$Aspiculuris_Syphacia + 1
BALdata$`OPG+1` <- BALdata$OPG + 1

# and select variables for each analysis
pinworms_data <- BALdata[!is.na(BALdata$`Aspiculuris.Syphacia+1`) &
                           !is.na(BALdata$HI) &
                           !is.na(BALdata$Sex),]

WATWMdata <- WATWMdata[!is.na(WATWMdata$`Aspiculuris.Syphacia+1`) &
                         !is.na(WATWMdata$HI) &
                         !is.na(WATWMdata$Sex), ]

# all worms together for comparison
d1 <- WATWMdata[c("Sex", "Aspiculuris.Syphacia+1", "HI")]
d2 <- pinworms_data[c("Sex", "Aspiculuris.Syphacia+1", "HI")]
d1$batch <- "WATWM"
d2$batch <- "JENNY"
allWorms <- rbind(d1,d2)
allWorms$batch <- as.factor(allWorms$batch)
```

## Worms count, 4 hypotheses, difference between sexes (Baird et al. 2012 for details)

First, choose a correct distribution for our data : negative binomial. We validate this distribution as follow

```{r}
x <- BALdata$Aspiculuris_Syphacia[!is.na(BALdata$Aspiculuris_Syphacia)]

averageload <- round(mean(x, na.rm = T),1)
averageload 
Ni <- sum(x !=0, na.rm = T)
Ni 
# Confidence intervals calculated with Sterne's exact method
sternetest <- epiR::epi.prev(pos = length(x[x > 0]), tested = length(x),
                             se = 1, sp=1, conf.level = .95, method = "sterne")
cilow <- sternetest$ap["lower"]
cihigh <- sternetest$ap["upper"]
prevalence <- sternetest$ap["est"]

Ni
prevalence 
cilow
cihigh

Meanload <-  mean(x, na.rm = T)
max <- max(x, na.rm = T)
Meanload 
max

set.seed(8345) # to make it replicable
b1 <- one.boot(x, mean, R=10000)
b1$t0
boot.ci(b1, type=c("bca")) 

# Prevalence Ni (%)
# [CI 95%]
# 321 (52.9%)
# [48.85–56.84]

# Mean load (Max)
# [CI 95%]
# 19.67 (489)
# [16.22–24.56]

## MLE of parameter k negbin
hist(x, prob=T, breaks = max(x))
# fit the negative binomial distribution
fit <- fitdist(x, "nbinom")
# get the fitted densities. mu and size from fit.
fitD <- dnbinom(0:max(x), size=fit$estimate[1], mu=fit$estimate[2])
# add fitted line (blue) to histogram
lines(fitD, lwd="3", col="blue")
# Goodness of fit with the chi squared test  
# get the frequency table
t <- table(x)   
# convert to dataframe
df <- as.data.frame(t)
df$x <- as.numeric(as.character(df$x))
df$expp <- pnbinom(q = df$x, size=fit$estimate[1], mu = fit$estimate[2])
df$obsp <- cumsum(df$Freq / sum(df$Freq))
# perform the chi-squared test
chisq.test(x = df$expp, y = df$obsp)

# Pearson's Chi-squared test
# 
# data:  df$expp and df$obsp
# X-squared = 9120, df = 9025, p-value = 0.239

# Observed and expected frequencies do not differ significantly (P =
# 0.05) so there is no statistical evidence to reject H 0

size=fit$estimate[1]
size
# The negative binomial distribution seems to describe parasite load well for all parasites
```

### pinworms (A. tetraptera and S. obvelata (WATWMdata$Aspiculuris.Syphacia))

```{r runfitJo, fig.width=7, fig.height=4}
fit_Joelle_negbin <- analyse(WATWMdata, "Aspiculuris.Syphacia+1",
                             model = "negbin", group = "Sex")
fit_Joelle_negbin

plot_Joelle_negbin <- bananaPlots(mod = fit_Joelle_negbin$H3,
                                  data = WATWMdata,
                                  response = "Aspiculuris.Syphacia+1",
                                  islog10 = TRUE, group = "Sex")
plot_Joelle_negbin
```

### And Jennys now:

```{r runfitJe,  fig.width=7, fig.height=4}
fit_pinworms_negbin <- analyse(pinworms_data, response = "Aspiculuris.Syphacia+1",
                               model = "negbin", group = "Sex")
fit_pinworms_negbin

plot_pinworms_negbin <- bananaPlots(mod = fit_pinworms_negbin$H3,
                                    data = pinworms_data,
                                    response = "Aspiculuris.Syphacia+1",
                                    islog10 = TRUE, group = "Sex")
plot_pinworms_negbin

pdf(file = "../figures/part1.pdf", width=7, height=4)
plot_pinworms_negbin
dev.off()
```

To compare both dataset hybrid effect (alpha) we run 2 models with our data: 

* model A with fixed alpha = 1.44 (males) alpha = 1.34 (females) (Bairds et al. 2012 value for pinworms)

* model B with variable alpha (model B being fit_pinworms_negbin)

then we compare via G-test.

```{r}
defaultConfig <- list(optimizer = "optimx",
                      method = c("L-BFGS-B", "bobyqa"),
                      control = list(follow.on = TRUE))

## Female: alpha fixed at 1.34
model = "negbin"
data = pinworms_data[pinworms_data$Sex =="F",]
response = "Aspiculuris.Syphacia+1"
paramBounds <- getParamBounds(model, data, response)
paramBounds[["alphaStart"]] <- 1.34
paramBounds[["alphaUB"]] <- 1.35
paramBounds[["alphaLB"]] <- 1.33

fitF <- FitAdvancedAlphaNegbin(data, response, hybridIndex = "HI", 
                        paramBounds, config = defaultConfig)

## Male: alpha fixed at 1.44
model = "negbin"
data = pinworms_data[pinworms_data$Sex =="M",]
response = "Aspiculuris.Syphacia+1"
paramBounds <- getParamBounds(model, data, response)
paramBounds[["alphaStart"]] <- 1.44
paramBounds[["alphaUB"]] <- 1.45
paramBounds[["alphaLB"]] <- 1.43

fitM <- FitAdvancedAlphaNegbin(data, response, hybridIndex = "HI", 
                        paramBounds, config = defaultConfig)

# Gtest
LL1 <- logLik(fitF) + logLik(fitF)
LL2 <- logLik(fit_pinworms_negbin$H3$groupA) + 
  logLik(fit_pinworms_negbin$H3$groupB)
dLL <- LL1 - LL2
dDF <- 2 # 2 alpha fixed in one case
1 - pchisq(2*0.66, df=2)

```
